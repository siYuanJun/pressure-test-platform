# Bash脚本改造说明

## 一、改造目标

将原有的交互式压测脚本改造为支持FastAPI后端调用的API模式，实现：
1. 接收FastAPI传递的参数（target_url、concurrency、duration、threads）
2. 执行压测后输出标准化JSON格式结果
3. 支持与Python接口的数据交互
4. 兼容Linux/Mac系统

## 二、改造方案

### 2.1 新增API模式脚本

创建了 `start_api.sh` 脚本，专门用于API模式调用。

**原有脚本备份**：
- 原始 `start.sh` 已备份至 `原有脚本备份/start.sh.backup`
- 保留原有交互式功能不变

### 2.2 API模式脚本特性

#### 参数说明

| 参数 | 说明 | 必需 | 示例 |
|------|------|------|------|
| `--target-url` | 压测目标URL | 是 | `--target-url=https://example.com` |
| `--concurrency` | 并发连接数 | 否（默认100） | `--concurrency=200` |
| `--duration` | 压测持续时间 | 否（默认30s） | `--duration=60s` |
| `--threads` | 线程数 | 否（默认4） | `--threads=8` |
| `--task-id` | 任务ID（用于文件命名） | 否 | `--task-id=123` |
| `--script-path` | Lua脚本路径（可选） | 否 | `--script-path=/path/to/script.lua` |
| `--output-json` | JSON输出文件路径 | 否（自动生成） | `--output-json=/path/to/result.json` |

#### 执行示例

```bash
./start_api.sh \
  --target-url=https://example.com \
  --concurrency=200 \
  --duration=60s \
  --threads=4 \
  --task-id=123
```

#### 输出格式

脚本会输出JSON格式的结果文件，包含以下字段：

```json
{
  "success": true,
  "task_id": "123",
  "target_url": "https://example.com",
  "concurrency": 200,
  "duration": "60s",
  "threads": 4,
  "qps": 91.13,
  "avg_latency_ms": 123.45,
  "p95_latency_ms": 234.56,
  "p99_latency_ms": 345.67,
  "error_rate": 0.5,
  "total_requests": 2734,
  "successful_requests": 2720,
  "failed_requests": 14,
  "data_file_path": "/path/to/data.csv",
  "raw_output": "原始wrk输出..."
}
```

### 2.3 与Python接口交互

#### 数据流向

```
FastAPI后端
  ↓ (调用start_api.sh)
Bash脚本执行压测
  ↓ (生成JSON结果文件)
FastAPI读取JSON文件
  ↓ (保存到数据库)
任务完成，触发报告生成
```

#### 文件路径约定

- **JSON结果文件**：`data/task_{task_id}_result.json`
- **CSV数据文件**：`data/task_{task_id}_{timestamp}.csv`
- **报告文件**：`reports/` 目录下

### 2.4 错误处理

脚本在以下情况会返回错误：

1. **参数缺失**：缺少必需的 `--target-url` 参数
2. **执行失败**：wrk命令执行失败（网络错误、超时等）
3. **解析失败**：无法解析wrk输出

错误时输出JSON格式：

```json
{
  "success": false,
  "error": "错误描述",
  "exit_code": 1,
  "output": "错误输出..."
}
```

## 三、兼容性说明

### 3.1 系统兼容

- **Linux**：支持 CentOS 7+、Ubuntu 18.04+
- **macOS**：支持 macOS 10.15+

### 3.2 依赖工具

脚本依赖以下工具（需预先安装）：

- `wrk`：压测工具
- `jq`：JSON处理工具（用于生成JSON输出）
- `bc`：数学计算工具（用于计算错误率）

安装方法：

```bash
# macOS
brew install wrk jq bc

# Linux (Ubuntu)
sudo apt-get install wrk jq bc

# Linux (CentOS)
sudo yum install wrk jq bc
```

### 3.3 执行权限

确保脚本有执行权限：

```bash
chmod +x start_api.sh
```

## 四、集成到FastAPI

### 4.1 调用方式

在FastAPI的 `task_service.py` 中调用：

```python
cmd = [
    "bash",
    script_path,
    "--api-mode",
    f"--target-url={task.target_url}",
    f"--concurrency={task.concurrency}",
    f"--duration={task.duration}",
    f"--threads={task.threads}",
    f"--task-id={task_id}"
]
```

### 4.2 读取结果

执行完成后，读取JSON结果文件：

```python
result_file = f"data/task_{task_id}_result.json"
with open(result_file, 'r') as f:
    result_data = json.load(f)
```

## 五、后续优化建议

1. **增强wrk输出解析**：当前解析较为简化，可以增强以提取更多指标
2. **支持多URL压测**：扩展脚本支持同时压测多个URL
3. **实时日志输出**：支持实时输出压测进度到标准输出
4. **进程管理**：支持任务取消功能，能够终止正在执行的压测
5. **结果验证**：增加结果数据的有效性验证

## 六、测试建议

1. **单元测试**：测试参数解析、JSON生成等功能
2. **集成测试**：测试与FastAPI的完整交互流程
3. **性能测试**：测试脚本在不同负载下的表现
4. **错误测试**：测试各种错误场景的处理

## 七、注意事项

1. **路径问题**：确保脚本路径和输出路径使用绝对路径或相对于脚本目录的路径
2. **权限问题**：确保脚本有执行权限，输出目录有写权限
3. **资源限制**：注意系统资源限制（文件描述符、内存等）
4. **并发安全**：如果多个任务同时执行，注意文件命名冲突问题

