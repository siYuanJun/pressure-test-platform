# 开发环境配置文档

本文档说明如何搭建压测平台的开发环境。

## 一、环境要求

### 1.1 操作系统
- **推荐**：macOS 10.15+ 或 Linux (Ubuntu 20.04+/CentOS 7+)
- **最低要求**：支持 Bash 4.0+ 和 Python 3.10+

### 1.2 必需软件
- **Python**: 3.10 或更高版本
- **Node.js**: 18.x 或更高版本（推荐使用 nvm 管理）
- **MySQL**: 8.0 或更高版本
- **Git**: 2.0 或更高版本
- **Docker** (可选): 用于容器化部署

### 1.3 开发工具
- **代码编辑器**: VS Code / PyCharm / WebStorm
- **数据库管理工具**: MySQL Workbench / DBeaver / Navicat
- **API测试工具**: Postman / Insomnia

## 二、环境安装步骤

### 2.1 Python 环境安装

#### macOS
```bash
# 使用 Homebrew 安装
brew install python@3.10

# 或使用 pyenv 管理多个 Python 版本
brew install pyenv
pyenv install 3.10.12
pyenv global 3.10.12
```

#### Linux (Ubuntu)
```bash
# 更新包列表
sudo apt update

# 安装 Python 3.10
sudo apt install python3.10 python3.10-venv python3.10-dev

# 安装 pip
sudo apt install python3-pip
```

#### 验证安装
```bash
python3 --version  # 应显示 Python 3.10.x
pip3 --version
```

### 2.2 Node.js 环境安装

#### 使用 nvm (推荐)
```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载 shell 配置
source ~/.bashrc  # 或 source ~/.zshrc

# 安装 Node.js 18
nvm install 18
nvm use 18
nvm alias default 18
```

#### macOS (使用 Homebrew)
```bash
brew install node@18
```

#### Linux (Ubuntu)
```bash
# 使用 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

#### 验证安装
```bash
node --version  # 应显示 v18.x.x
npm --version
```

### 2.3 MySQL 安装

#### macOS
```bash
# 使用 Homebrew 安装
brew install mysql@8.0
brew services start mysql@8.0

# 设置 root 密码
mysql_secure_installation
```

#### Linux (Ubuntu)
```bash
# 安装 MySQL
sudo apt update
sudo apt install mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### 验证安装
```bash
mysql --version  # 应显示 mysql Ver 8.0.x
mysql -u root -p  # 测试连接
```

### 2.4 Git 安装

#### macOS
```bash
# 通常已预装，或使用 Homebrew
brew install git
```

#### Linux
```bash
sudo apt install git
```

## 三、项目环境配置

### 3.1 克隆项目（如果使用 Git）

```bash
cd /path/to/workspace
git clone <repository-url> pressure-test-platform
cd pressure-test-platform
```

### 3.2 数据库配置

#### 3.2.1 创建数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行建表脚本
mysql -u root -p < databases_sql/schema.sql

# 或手动创建
mysql -u root -p
CREATE DATABASE pressure_test_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE pressure_test_platform;
SOURCE databases_sql/schema.sql;
```

#### 3.2.2 创建数据库用户（可选，推荐用于开发）

```sql
-- 创建开发用户
CREATE USER 'pt_dev'@'localhost' IDENTIFIED BY 'your_password_here';
GRANT ALL PRIVILEGES ON pressure_test_platform.* TO 'pt_dev'@'localhost';
FLUSH PRIVILEGES;
```

### 3.3 后端环境配置

#### 3.3.1 进入后端目录

```bash
cd backend_admin_python
```

#### 3.3.2 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate

# Windows:
# venv\Scripts\activate
```

#### 3.3.3 安装依赖

```bash
# 升级 pip
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

#### 3.3.4 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，修改以下配置：
# - DATABASE_URL: MySQL 连接字符串
# - JWT_SECRET_KEY: JWT 密钥（生产环境请使用强随机字符串）
# - 其他配置项
```

`.env` 文件示例：
```env
DATABASE_URL=mysql+pymysql://pt_dev:your_password@localhost:3306/pressure_test_platform
JWT_SECRET_KEY=your-secret-key-here-change-in-production
DEBUG=True
```

#### 3.3.5 验证后端环境

```bash
# 测试数据库连接
python -c "from sqlalchemy import create_engine; engine = create_engine('mysql+pymysql://pt_dev:password@localhost:3306/pressure_test_platform'); print('连接成功')"

# 启动开发服务器
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

访问 http://localhost:8000/docs 查看 Swagger API 文档。

### 3.4 前端环境配置

#### 3.4.1 管理后台前端

```bash
# 进入管理后台目录
cd ../frontend_admin_web

# 安装依赖
npm install
# 或使用 yarn
yarn install

# 配置环境变量（如需要）
# 创建 .env.local 文件
echo "API_BASE_URL=http://localhost:8000/api" > .env.local

# 启动开发服务器
npm run dev
# 或
yarn dev
```

访问 http://localhost:8000 (或配置的端口)

#### 3.4.2 用户前台前端

```bash
# 进入用户前台目录
cd ../frontend_client_web

# 安装依赖
npm install
# 或使用 yarn
yarn install

# 配置环境变量
# 创建 .env.local 文件
echo "NEXT_PUBLIC_API_BASE_URL=http://localhost:8000/api" > .env.local

# 启动开发服务器
npm run dev
# 或
yarn dev
```

访问 http://localhost:3000

### 3.5 Bash 脚本环境配置

#### 3.5.1 检查 wrk 工具

```bash
# 检查是否已安装 wrk
which wrk
wrk --version

# 如果未安装，需要安装 wrk
# macOS:
brew install wrk

# Linux (Ubuntu):
sudo apt install wrk

# 或从源码编译
git clone https://github.com/wg/wrk.git
cd wrk
make
sudo cp wrk /usr/local/bin
```

#### 3.5.2 配置脚本权限

```bash
cd backend_admin_wrk_bash

# 添加执行权限
chmod +x start.sh
chmod +x bench_all_in_one.sh
chmod +x lib/*.sh

# 测试脚本
./start.sh --help
```

#### 3.5.3 配置脚本路径

确保 `backend_admin_python/.env` 中的脚本路径配置正确：

```env
WRK_SCRIPT_PATH=../backend_admin_wrk_bash/start.sh
WRK_DATA_DIR=../backend_admin_wrk_bash/data
WRK_REPORT_DIR=../backend_admin_wrk_bash/reports
```

## 四、启动顺序

### 4.1 开发环境启动顺序

1. **启动 MySQL 服务**
   ```bash
   # macOS
   brew services start mysql@8.0
   
   # Linux
   sudo systemctl start mysql
   ```

2. **启动后端服务**
   ```bash
   cd backend_admin_python
   source venv/bin/activate
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

3. **启动管理后台前端**（新终端）
   ```bash
   cd frontend_admin_web
   npm run dev
   ```

4. **启动用户前台前端**（新终端）
   ```bash
   cd frontend_client_web
   npm run dev
   ```

### 4.2 验证服务

- 后端 API: http://localhost:8000/docs
- 管理后台: http://localhost:8000 (或配置的端口)
- 用户前台: http://localhost:3000

## 五、常见问题排查

### 5.1 Python 相关问题

**问题**: `ModuleNotFoundError: No module named 'xxx'`
```bash
# 解决方案：确保虚拟环境已激活，重新安装依赖
source venv/bin/activate
pip install -r requirements.txt
```

**问题**: `mysql.connector.errors.InterfaceError: 2003: Can't connect to MySQL server`
```bash
# 解决方案：检查 MySQL 服务是否启动
# macOS
brew services list | grep mysql

# Linux
sudo systemctl status mysql
```

### 5.2 Node.js 相关问题

**问题**: `npm ERR! code ELIFECYCLE`
```bash
# 解决方案：清除缓存，重新安装
rm -rf node_modules package-lock.json
npm install
```

**问题**: 端口被占用
```bash
# 查找占用端口的进程
lsof -i :8000  # macOS
netstat -tulpn | grep 8000  # Linux

# 杀死进程
kill -9 <PID>
```

### 5.3 数据库相关问题

**问题**: `Access denied for user`
```bash
# 解决方案：检查用户名、密码和权限
mysql -u root -p
GRANT ALL PRIVILEGES ON pressure_test_platform.* TO 'pt_dev'@'localhost';
FLUSH PRIVILEGES;
```

**问题**: 字符集问题
```sql
-- 检查数据库字符集
SHOW VARIABLES LIKE 'character_set%';

-- 确保使用 utf8mb4
ALTER DATABASE pressure_test_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 5.4 Bash 脚本问题

**问题**: `Permission denied`
```bash
# 解决方案：添加执行权限
chmod +x start.sh
chmod +x bench_all_in_one.sh
chmod +x lib/*.sh
```

**问题**: `wrk: command not found`
```bash
# 解决方案：安装 wrk 工具
# macOS
brew install wrk

# Linux
sudo apt install wrk
```

## 六、开发工具推荐

### 6.1 VS Code 插件

- **Python**: Python 扩展
- **ESLint**: JavaScript/TypeScript 代码检查
- **Prettier**: 代码格式化
- **MySQL**: 数据库管理
- **Docker**: Docker 支持

### 6.2 数据库管理工具

- **MySQL Workbench**: 官方 GUI 工具
- **DBeaver**: 跨平台数据库工具
- **TablePlus**: 现代化数据库管理工具（macOS）

### 6.3 API 测试工具

- **Postman**: 功能强大的 API 测试工具
- **Insomnia**: 轻量级 API 客户端
- **Swagger UI**: 内置在 FastAPI 中，访问 /docs

## 七、环境变量说明

### 7.1 后端环境变量 (.env)

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| DATABASE_URL | MySQL 连接字符串 | mysql+pymysql://user:pass@localhost:3306/db |
| JWT_SECRET_KEY | JWT 密钥 | 随机字符串（生产环境需强密钥） |
| JWT_ALGORITHM | JWT 算法 | HS256 |
| JWT_ACCESS_TOKEN_EXPIRE_MINUTES | Token 过期时间（分钟） | 30 |
| DEBUG | 调试模式 | True/False |
| CORS_ORIGINS | 允许的跨域来源 | http://localhost:3000,http://localhost:3001 |

### 7.2 前端环境变量

#### 管理后台 (.env.local)
```
API_BASE_URL=http://localhost:8000/api
```

#### 用户前台 (.env.local)
```
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000/api
```

## 八、下一步

环境配置完成后，可以开始：

1. **阶段二**: 开发 FastAPI 接口与压测核心
2. **阶段三**: 开发管理后台前端
3. **阶段四**: 开发用户前台前端
4. **阶段五**: 系统集成与部署

详细开发指南请参考各阶段的 README 文档。

